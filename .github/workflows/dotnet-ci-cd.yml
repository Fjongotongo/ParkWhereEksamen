name: .NET CI-CD Pipeline

# -----------------------------------------
# 1) When the pipeline runs
# -----------------------------------------
on:
  push:
    branches: [ "main" ]   # Run on pushes to main (CD)
  pull_request:
    branches: [ "main" ]   # Run on PRs (CI)
  workflow_dispatch:        # Allow manual execution

# -----------------------------------------
# 2) Pipeline jobs
# -----------------------------------------
jobs:

  # -----------------------------------------
  # A) BUILD AND TEST (CI)
  # -----------------------------------------
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Install .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # 3) Restore NuGet dependencies
      - name: Restore dependencies
        run: dotnet restore

      # 4) Build the solution
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # 5) Run unit tests
      - name: Run tests
        run: dotnet test --no-restore --verbosity normal


  # -----------------------------------------
  # B) DEPLOY (CD)
  # Only runs if build & tests succeed
  # -----------------------------------------
  deploy:
    needs: build_and_test        # Only run this job if CI passes
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'   # Only deploy on main branch

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # 1) Publish the app (creates a deploy-ready folder)
      - name: Publish application
        run: dotnet publish -c Release -o ./publish

      # 2) Upload artifacts (optional)
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-app
          path: ./publish

      # 3) Example deployment (SSH to server)
      # Replace with your real deployment method
      - name: Deploy to server (example)
        run: |
          echo "Deploying to server..."
          # Example SSH upload
          # scp -r ./publish/* user@server:/var/www/app